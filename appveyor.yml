# Notes:
#   - Minimal appveyor.yml file is an empty file. All sections are optional.
#   - Indent each level of configuration with 2 spaces. Do not use tabs!
#   - All section names are case-sensitive.
#   - Section names should be unique on each level.
# 	- Full Reference: https://www.appveyor.com/docs/appveyor-yml

#---------------------------------#
#      general configuration      #
#---------------------------------#
  
  # version format
  version: 0.9.{build}

  # you can use {branch} name in version format too
  # version: 1.0.{build}-{branch}

  # branches to build
  branches:
    # whitelist
    only:
    - master

    # blacklist
    except:
  
#---------------------------------#
#    environment configuration    #
#---------------------------------#
	
  # Build worker image (VM template)
  image: Visual Studio 2015
  
  # enable service required for build/tests
  services:
    # start SQL Server 2012 SP1 Express
    - mssql2012sp1 		
  
  # enable patching of AssemblyInfo.* files
  assembly_info:
    patch: true
    file: AssemblyInfo.*
    assembly_version: '{version}-dev'
    assembly_file_version: "{version}"
    assembly_informational_version: "{version}"
  
  
  # Automatically register private account and/or project AppVeyor NuGet feeds.
  nuget:
    project_feed: true
  
  
#---------------------------------#
#       build configuration       #
#---------------------------------#
  
  # build platform, i.e. x86, x64, Any CPU. This setting is optional.
  platform: Any CPU
  
  # build Configuration, i.e. Debug, Release, etc.
  configuration: Release
  
  build:
    # path to Visual Studio solution or project
    # package projects with .nuspec files and push to artifacts
    # add -IncludeReferencedProjects option while packaging NuGet
    project: prefSQL.sln	
    publish_nuget: true		 
    include_nuget_references: true

  # scripts to run before build
  before_build:
    - nuget restore


#---------------------------------#
#       tests configuration       #
#---------------------------------#

  # to run your custom scripts instead of automatic tests
  test_script:
    - ps: |
    $startPath = "$($env:appveyor_build_folder)\bin\Debug"
    $sqlInstance = "(local)\SQL2012SP1"
    $dbName = "ecommercetest"

    # replace the db connection with the local instance
    $config = join-path $startPath "App.config"
    $doc = (gc $config) -as [xml]
    $doc.SelectSingleNode('//connectionStrings/add[@name="unittest"]').connectionString = "Server=$sqlInstance; Database=$dbName; Trusted_connection=true"
    $doc.Save($config)
 
    # attach mdf to local instance
    $mdfFile = join-path $startPath "ecommercetest.mdf"
    $ldfFile = join-path $startPath "ecommercetest_log.ldf"
    sqlcmd -S "$sqlInstance" -Q "Use [master]; CREATE DATABASE [$dbName] ON (FILENAME = '$mdfFile'),(FILENAME = '$ldfFile') for ATTACH"